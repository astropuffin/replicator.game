<div align="center">
  <br>
  Buy Replicator Today! (pre-alpha, so expect lots of bugs)
  <button id="signin-button">Signin with google to buy!</button>
  <button id="signout-button">Signout of google</button>

  <script src="https://js.stripe.com/v3/"></script>
  <script type="text/javascript">
    var stripe = Stripe("{{ .Site.Params.stripeApiKey }}");
    var elements = stripe.elements();
  </script>

  <!-- The core Firebase JS SDK is always required and must be listed first -->
  <script src="https://www.gstatic.com/firebasejs/7.6.2/firebase-app.js"></script>

  <!-- TODO: Add SDKs for Firebase products that you want to use
       https://firebase.google.com/docs/web/setup#available-libraries -->
  <script src="https://www.gstatic.com/firebasejs/7.6.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/7.6.1/firebase-functions.js"></script>
  <script src="https://www.gstatic.com/firebasejs/7.6.2/firebase-analytics.js"></script>

  <script>
    // Your web app's Firebase configuration
    var firebaseConfig = {
      apiKey: "AIzaSyAF1lJA8a_CAjLHNmZvRjG2E6XwT0OBxdc",
      authDomain: "replicatorgamecom.firebaseapp.com",
      databaseURL: "https://replicatorgamecom.firebaseio.com",
      projectId: "replicatorgamecom",
      storageBucket: "replicatorgamecom.appspot.com",
      messagingSenderId: "797488050185",
      appId: "1:797488050185:web:377e60ea68c8c004bd88d8",
      measurementId: "G-YQLB3K6YPD"
    };
    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    firebase.analytics();
  </script>

  <form action="{{ .Site.Params.stripeEndpoint }}" method="post" id="payment-form">
    <input type=hidden id="firebaseUid" name="firebaseUid" value=""/>
    <div class="form-row">
      <label for="card-element">
        Credit or debit card
      </label>
      <div id="card-element">
        <!-- A Stripe Element will be inserted here. -->
      </div>

      <!-- Used to display Element errors. -->
      <div id="card-errors" role="alert"></div>
    </div>

    <button>Submit Payment</button>
  </form>
  <script type="text/javascript">
    // Custom styling can be passed to options when creating an Element.
    var style = {
      base: {
        // Add your base input styles here. For example:
        fontSize: '16px',
        color: '#32325d',
      },
    };
    
    // Create an instance of the card Element.
    var card = elements.create('card', {style: style});
    
    // Add an instance of the card Element into the `card-element` <div>.
    card.mount('#card-element');

    // Create a token or display an error when the form is submitted.
    var form = document.getElementById('payment-form');
    form.addEventListener('submit', function(event) {
      event.preventDefault();
    
      stripe.createToken(card).then(function(result) {
        if (result.error) {
          // Inform the customer that there was an error.
          var errorElement = document.getElementById('card-errors');
          errorElement.textContent = result.error.message;
        } else {
          // Send the token to your server.
          stripeTokenHandler(result.token);
        }
      });
    });

    function stripeTokenHandler(token) {
      // Insert the token ID into the form so it gets submitted to the server
      var form = document.getElementById('payment-form');
      var hiddenInput = document.createElement('input');
      hiddenInput.setAttribute('type', 'hidden');
      hiddenInput.setAttribute('name', 'stripeToken');
      hiddenInput.setAttribute('value', token.id);
      form.appendChild(hiddenInput);
    
      // Submit the form
      form.submit();
    }
  </script>

  <script type="text/javascript">
    var signinButton  = document.getElementById('signin-button');
    var signoutButton = document.getElementById('signout-button');
    var stripeForm = document.getElementById('payment-form');

    signinButton.style.display = 'none';
    signoutButton.style.display = 'none';
    stripeForm.style.display = 'none';

	function handleClientLoad() {
      //wait for firebase to finish initializing
      firebase.auth().useDeviceLanguage();
      firebase.auth().onAuthStateChanged(function(user) {
        //console.log("Firebase initialized.");
        //TODO: Add a latch function to show loading until firebase is initialized, in order to prevent "login" events
        // from firing beforehand. Should keep the "login" button disabled until this latch triggers.
        if (user) {
          updateSigninStatus(true);
        } else {
          updateSigninStatus(false);
        }
      });
      signinButton.onclick = handleSigninClick;
      signoutButton.onclick = handleSignoutClick;
    }

    function updateSigninStatus(isSignedIn) {
      if (isSignedIn) {
        var user = firebase.auth().currentUser;
        signinButton.style.display = 'none';
        signoutButton.style.display = 'block';
        stripeForm.style.display = 'block';
        //TODO: use var stripeForm instead
        document.getElementById("payment-form").setAttribute("firebaseUID",user.uid);
        console.log(user.displayName + " with UID " + user.uid + " and email " + user.email + " is signed in.");
      } else {
        signinButton.style.display = 'block';
        signoutButton.style.display = 'none';
        stripeForm.style.display = 'none';
        //TODO: use var stripeForm instead
        document.getElementById("payment-form").setAttribute("firebaseUID","");
        console.log("unknown user.");
      }
    }
    function handleSigninClick() {
      var provider = new firebase.auth.GoogleAuthProvider();
      firebase.auth().signInWithPopup(provider).then(function(result) {
        console.log("sign in");
        //_updateSigninStatus(true); //should already be listening for event
        // This gives you a Google Access Token. You can use it to access the Google API.
        var token = result.credential.accessToken;
      }).catch(function(error) {
        //_updateSigninStatus(false);
        // Handle Errors here.
        var errorCode = error.code;
        var errorMessage = error.message;
        // The email of the user's account used.
        var email = error.email;
        // The firebase.auth.AuthCredential type that was used.
        var credential = error.credential;
        // ...
      });
    }
    function handleSignoutClick() {
      firebase.auth().signOut().then(function() {
        console.log("signout");
        //_updateSigninStatus(false); //should already be listening for event
      }).catch(function(error) {
        console.log("error signing out.");
        console.log(error);
      });
    }
  </script>

  <script defer type="text/javascript">
    handleClientLoad();
  </script>
</div>
